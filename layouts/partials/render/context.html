{{/* Determine value of the audits context depends of his location */}}
{{- $context    := .context -}}
{{- $project    := .project -}}
{{- $rootpath   := (partialCached "render/rootpath" (dict "context" $context "project" $project "type" "accessibility") $project "accessibility") -}}
{{- $path       := replace (replace (cond (not $project) (printf "/%s/%s" $rootpath "accessibility") (printf "/%s/%s/%s" $rootpath $project "accessibility")) "///" "/") "//" "/" -}}
{{- $path       := (replace $path "/audits/audits/" "/audits/") -}}
{{- $context.Scratch.Set "date" "" -}}

{{- if fileExists $path -}}
  {{- range $id, $value := readDir $path -}}
    {{- if eq .Name "context.yml" -}}
      {{- $file := ((readFile (printf "%s/%s/accessibility/%s" $rootpath $project .Name) | transform.Unmarshal)) -}}
      {{- range $date, $value := $file.audits -}}
      {{- $context.Scratch.SetInMap "context" $date (dict "contacts" $file.contacts "website" $file.website "audit" (index $file.audits $date)) -}}
      {{- end -}}
    {{- else -}}
    {{- $context.Scratch.Set "date" (replace .Name (path.Ext .Name) "") -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- if not ($context.Scratch.Get "context") -}}
{{/* In a front matter of the current page */}}
{{- with $context.GetPage (printf "/audits/%s/_index.md" $project) -}}{{ $context.Scratch.SetInMap "context" ($context.Scratch.Get "date") (dict "contacts" .Params.accessibility.contacts "website" .Params.accessibility.website "audit" (.Params.accessibility.audit)) }}{{- end -}}
{{- with $context.GetPage (printf "/audits/%s/index.md" $project)  -}}{{ $context.Scratch.SetInMap "context" ($context.Scratch.Get "date") (dict "contacts" .Params.accessibility.contacts "website" .Params.accessibility.website "audit" (.Params.accessibility.audit)) }}{{- end -}}
{{- with $context.GetPage (printf "/audits/index.md" $project)  -}}{{ $context.Scratch.SetInMap "context" ($context.Scratch.Get "date") (dict "contacts" .Params.accessibility.contacts "website" .Params.accessibility.website "audit" (.Params.accessibility.audit)) }}{{- end -}}
{{/* In a file name accessibility.md presents i the project folder  */}}
{{- with $context.GetPage (printf "/audits/%s/accessibility.md" $project) -}}{{ $context.Scratch.SetInMap "context" ($context.Scratch.Get "date") (dict "contacts" .Params.accessibility.contacts "website" .Params.accessibility.website "audit" (.Params.accessibility.audit)) }}{{- end -}}
{{- with $context.GetPage (printf "/audits/accessibility.md" $project) -}}{{ $context.Scratch.SetInMap "context" ($context.Scratch.Get "date") (dict "contacts" .Params.accessibility.contacts "website" .Params.accessibility.website "audit" (.Params.accessibility.audit)) }}{{- end -}}
{{- end -}}
{{ if not ($.context.Scratch.Get "context") }}
{{- else -}}
{{ if not (index ($.context.Scratch.Get "context") ($context.Scratch.Get "date")).contacts }}
{{- warnf "%s %s"  "Contacts informations are missing or misformed in" $project -}}
{{ end }}
{{ if not (index ($.context.Scratch.Get "context") ($context.Scratch.Get "date")).website }}
{{- warnf "%s %s"  "Website informations are missing or misformed in" $project -}}
{{ end }}
{{ if not (index ($.context.Scratch.Get "context") ($context.Scratch.Get "date")).audit }}
{{- warnf "%s %s"  "Audit informations are missing or misformed in" $project -}}
{{ end }}
{{ end }}
{{- return ($.context.Scratch.Get "context") -}}
