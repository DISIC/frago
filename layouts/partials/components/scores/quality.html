
{{- $project := .project -}}
{{- $pathlen := len (split .context.Path "/") -}}

{{- if (fileExists "data/quality/") -}}
  {{- $.context.Scratch.Set "dir" (readDir "data/quality/") -}}
{{- end -}}
{{- if and $project (not (eq $project "index")) (printf "data/%s/quality/" $project) -}}
  {{- $.context.Scratch.Set "dir" (readDir (printf "data/%s/quality/" $project)) -}}
{{- end -}}

{{- with ($.context.Scratch.Get "dir") -}}
  {{- range last 1 . -}}
    {{- if (fileExists "data/quality/") -}}
      {{- $.context.Scratch.Set "lastfile" (getJSON (printf "data/quality/%s" .Name)) -}}
    {{- end -}}
    {{- if and $project (not (eq $project "index")) (printf "data/%s/quality/" $project) -}}
      {{- $.context.Scratch.Set "lastfile" (getJSON (printf "data/%s/quality/%s" $project .Name)) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- range ($.context.Scratch.Get "lastfile") -}}
  <div>
    {{- $.context.Scratch.Set "countererrorstotal" 0 -}}
    {{- $.context.Scratch.Set "countererrorschecked" 0 -}}
    {{- $.context.Scratch.Set "countererrorstypecode" 0 -}}
    {{- $.context.Scratch.Set "countererrorstypevisual" 0 -}}
    {{- $.context.Scratch.Set "countererrorstypestructure" 0 -}}
    {{- $.context.Scratch.Set "countererrorstypetext" 0 -}}
    {{- $.context.Scratch.Set "countererrorscritical" 0 -}}
    {{- $.context.Scratch.Set "countererrorsimportant" 0 -}}
    {{- $.context.Scratch.Set "countererrorsmedium" 0 -}}
    {{- range .pages -}}
    {{- range $b := .blocks -}}
    {{- range .errors -}}
      {{- $.context.Scratch.Add "countererrorstotal" 1 -}}
      {{- if .checked }}{{ $.context.Scratch.Add "countererrorschecked" 1 }}{{- end -}}
      {{- if in .type "code" }}{{ $.context.Scratch.Add "countererrorstypecode" 1 }}{{- end -}}
      {{- if in .type "vis" }}{{ $.context.Scratch.Add "countererrorstypevisual" 1 }}{{- end -}}
      {{- if in .type "structure" }}{{ $.context.Scratch.Add "countererrorstypestructure" 1 }}{{- end -}}
      {{- if in .type "text" }}{{ $.context.Scratch.Add "countererrorstypetext" 1 }}{{- end -}}
      {{- if in .status "criti" }}{{ $.context.Scratch.Add "countererrorscritical" 1 }}{{- end -}}
      {{- if in .status "important" }}{{ $.context.Scratch.Add "countererrorsimportant" 1 }}{{- end -}}
      {{- if in .status "moindre" }}{{ $.context.Scratch.Add "countererrorsmedium" 1 }}{{- end -}}
    {{- end -}}
    {{- end -}}
    {{- end -}}
    <div class="scores">
    <ul>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ $.context.Scratch.Get "countererrorstotal" }}</b><br>Au total</span></li>
      <li class="counter text-center d-inline-block good"><span><b class="h2">{{ $.context.Scratch.Get "countererrorschecked" }}</b><br>Corrig√©es</span></li>
    </ul>
    {{- if eq $pathlen 3 -}}
    <ul>
      <li class="counter text-center d-inline-block bad"><span><b class="h2">{{ $.context.Scratch.Get "countererrorscritical" }}</b><br><b class="emoticon">üö´ Critique</b></span></li>
      <li class="counter text-center d-inline-block medium"><span><b class="h2">{{ $.context.Scratch.Get "countererrorsimportant" }}</b><br><b class="emoticon">‚ùóÔ∏è Important</b></span></li>
      <li class="counter text-center d-inline-block normal"><span><b class="h2">{{ $.context.Scratch.Get "countererrorsmedium" }}</b><br><b class="emoticon">‚û∞ Moindre</b></span></li>
    </ul>
    <ul>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ $.context.Scratch.Get "countererrorstypecode" }}</b><br>Type code</span></li>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ $.context.Scratch.Get "countererrorstypevisual" }}</b><br>Type visuel</span></li>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ $.context.Scratch.Get "countererrorstypestructure" }}</b><br>Type structure</span></li>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ $.context.Scratch.Get "countererrorstypetext" }}</b><br>Type textuel</span></li>
    </ul>
    {{- end -}}
    </div>
  </div>
{{- end -}}

