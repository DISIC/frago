{{- define "main" -}}
{{/* Vars */}}
{{- $project :=  (index (split .Path "/") 1) -}}
{{- $pathimage := printf "./static/images/%s/" $project }}
{{- $.Scratch.Set "auditfile-csv" "" }}

{{/* Set the audit file */}}
{{/* Set the audit file - test if a specific file is called */}}
{{- if .Params.datafilename -}}
  {{/* Condition about structure level */}}
  {{- if eq (len (split .Path "/")) 3 -}}
  {{ $.Scratch.Set "auditpath-csv" (printf "static/%s/%s.csv" $project .Params.datafilename) }}
  {{- else -}}
  {{ $.Scratch.Set "auditpath-csv" (printf "static/%s.csv" .Params.datafilename) }}
  {{- end -}}
{{- else -}}
  {{/* Condition about structure level */}}
  {{- if eq (len (split .Path "/")) 3 -}}
    {{- $.Scratch.Set "auditpath-csv" (printf "static/%s/%s.csv" $project "accessibility") -}}
  {{- else -}}
  {{- $.Scratch.Set "auditpath-csv" (printf "static/%s.csv" $project "accessibility") -}}
  {{- end -}}
{{- end -}}

{{- $.Scratch.Set "auditfile-csv" (getCSV "," ($.Scratch.Get "auditpath-csv")) -}}

{{/* Condition about if CSV is empty :: this is for init a project with a blank file */}}
{{- $.Scratch.Set "is-csv-empty" 0 -}}
{{- $.Scratch.Set "totaltestspage" 0 -}}
{{- $.Scratch.Set "counterconformepage" 0 -}}
{{- $.Scratch.Set "counternonapplicablepage" 0 -}}
{{- $.Scratch.Set "counternonconformepage" 0 -}}
{{- $.Scratch.Set "countercriterepage" 0 -}}
{{- $.Scratch.Set "critere" "" -}}
{{- range $key, $value := after 1 ($.Scratch.Get "auditfile-csv") -}}
    {{- $critere := printf "%s.%s" (index . 0) (index . 1) -}}
    {{- if ne $critere ($.Scratch.Get "critere") -}}{{- $.Scratch.Set "countercriterepage" 0 -}}{{- $.Scratch.Set "valuecriterepage" slice -}}{{- end -}}
    {{- range after 3 . -}}
      {{- if or (eq . "c") (eq . "nc") -}}{{- $.Scratch.Add "is-csv-empty" 1 -}}{{- end -}}
      {{- if or (eq . "c") (eq . "nc") (eq . "na") (eq . "?") (gt (len .) 3) -}}{{- $.Scratch.Add "totaltestspage" 1 -}}{{- $.Scratch.Add "countercriterepage" 1 -}}{{- end -}}
      {{- if eq . "c" -}}{{- $.Scratch.Add "counterconformepage" 1 -}}{{- end -}}
      {{- if eq . "na" -}}{{- $.Scratch.Add "counternonapplicablepage" 1 -}}{{- end -}}
      {{- if and (ne . "na") (ne . "c") (ne . "?") (ne . "") (ne . "25") (ne . "50") (ne . "81") -}}{{- $.Scratch.Add "counternonconformepage" 1 -}}{{- end -}}
      {{- if ne ($.Scratch.Get "countercriterepage") 0 -}}{{- $.Scratch.SetInMap "criteretotal" (string $critere) ($.Scratch.Get "countercriterepage") -}}{{- end -}}
      {{- if . -}}
      {{- $.Scratch.Add "valuecriterepage" . -}}
      {{- $.Scratch.SetInMap "criterevalues" (string $critere) (uniq ($.Scratch.Get "valuecriterepage")) -}}
      {{- end -}}
    {{- end -}}
    {{- $.Scratch.Set "critere" $critere -}}
{{- end -}}
{{- range $id, $value := ($.Scratch.Get "criterevalues") -}}
  {{- if ne (len $value) 0 -}}
  {{- if eq (len $value) 1 -}}
    {{- if eq (index $value 0) "?" -}}{{- $.Scratch.SetInMap "valuecriterenonapplicablepage" (string $id) . -}}{{- end -}}
    {{- if eq (index $value 0) "c" -}}{{- $.Scratch.SetInMap "valuecritereconformepage" (string $id) . -}}{{- end -}}
    {{- if eq (index $value 0) "na" -}}{{- $.Scratch.SetInMap "valuecriterenonapplicablepage" (string $id) . -}}{{- end -}}
    {{- if or (eq (index $value 0) "nc") (gt (len (index $value 0)) 3) -}}{{- $.Scratch.SetInMap "valuecriterenonconformepage" (string $id) . -}}{{- end -}}
  {{- else -}}
    {{- if eq (len ($value | symdiff (slice "na" "c"))) 0 -}}{{- $.Scratch.SetInMap "valuecritereconformepage" (string $id) . -}}{{- end -}}
    {{- if ge (len ($value | symdiff (slice "na" "c"))) 1 -}}{{- $.Scratch.SetInMap "valuecriterenonconformepage" (string $id) . -}}{{- end -}}
  {{- end -}}
  {{- end -}}
{{- end -}}
<hr>

<div class="wrapper narrow audit">
{{- if eq (len (split .Path "/")) 3 -}}
<p class="no-print">⬅ <a href="/projects/{{ $project }}/" class="link-more link-back">Retour à la page projet</a></p>
{{- end -}}
<h1>{{ .Title }} <small>{{ if .Params.tags }}{{ range .Params.tags }}pour <a href="/tags/{{ . }}">{{ . }}</a>{{ end }}{{ end }}</small></h1>

{{- if gt (len .Content) 10 -}}
<div class="note">
{{- partial "elements/content.html" .Content -}}
</div>
{{- end -}}

{{- if and ($.Scratch.Get "auditfile-csv") ($.Scratch.Get "is-csv-empty") ($.Scratch.Get "totaltestspage") -}}

{{/* Create an array with all pages */}}
{{- $pages := (index ($.Scratch.Get "auditfile-csv") 0) | symdiff (slice "Thématiques" "Critères" "Tests") -}}

{{/* Call score components */}}
<h2 class="text-center">Scores -&nbsp;{{- len ($.Scratch.Get "criteretotal") -}}&nbsp;critères</h2>
<h3 class="mb-0">Conformité globale selon les critères</h3>
{{- partial "components/scores/accessibility-csv" (dict "context" . "auditfile" ($.Scratch.Get "auditfile-csv")) -}}
{{- if ($.Scratch.Get "totaltestspage") -}}
<div class="scores">
    <ul>
      <li class="counter text-center d-inline-block good"><span><b class="h2">{{- len ($.Scratch.Get "valuecritereconformepage") -}}</b><br>Critères conformes</span></li>
      <li class="counter text-center d-inline-block"><span><b class="h2">{{ len ($.Scratch.Get "valuecriterenonapplicablepage") }}</b><br>Critères non applicables</span></li>
      <li class="counter text-center d-inline-block bad"><span><b class="h2">{{ len ($.Scratch.Get "valuecriterenonconformepage")  }}</b><br>Critères non conformes</span></li>
    </ul>
</div>
{{- end -}}
{{/* If serveral pages tested */}}
{{- if gt (len $pages) 1 -}}
<h3 class="mb-0">Conformité détaillée de répartition des tests</h3>
{{- partial "components/scores/accessibility-graph-csv" (dict "context" . "auditfile" ($.Scratch.Get "auditfile-csv")) -}}

{{/* Call page parameters */}}
{{- with .Params.accessibility -}}
<h2>Contexte</h2>
<p>
  <strong>Version du référentiel&nbsp;: </strong>{{ .guidelines }}<br>
  <strong>Technologies utilisées sur le site&nbsp;: </strong>{{ delimit .technologies ", " }}<br>
  <strong>Outils pour réaliser l’audit&nbsp;: </strong>{{ delimit .tools ", " }}<br>
  <strong>Environnement de test&nbsp;: </strong>{{ delimit .environment ", " }}<br>
</p>
{{- end -}}

<hr>

{{/* If serveral pages tested */}}

<h2>Liste des pages auditées</h2>

{{/* Create a anchors menu */}}
<div class="tableofcontents">
  <h3>Accéder aux pages auditées</h3>
  <ul>
    <li><a href="#pagesall">Erreurs sur toutes les pages</a></li>
    {{/* Loop all pages for anchor navigation */}}
    {{- range $id, $value := $pages -}}
    <li><a href="#{{ . | urlize }}">{{ . }}</a></li>
    {{- end -}}
  </ul>
</div>
{{- end -}}

<h2>Par ordre des tests du référentiel RGAA</h2>

{{- if gt (len $pages) 0 -}}
{{/* Range map errors sort by RGAA order - on all pages */}}
<h3 id="pagesall">A - Erreurs présentes sur toutes les pages</h3>
{{- end -}}
{{- range $key, $value := after 1 ($.Scratch.Get "auditfile-csv") -}}
  {{ $content := delimit (uniq (after 3 .)) "" }}
  {{- $condcontentlen := gt (len $content) 2 -}}
  {{- $condcontentnc := (eq $content "nc") -}}
  {{- $condcontentc := (eq $content "c") -}}
  {{- $thematiques := index $value 0 -}}
  {{- $criteres := index $value 1 -}}
  {{- $tests := index $value 2 -}}
  {{ if eq (len (uniq (after 3 .))) 1 }}
  {{- range first 1 . -}}
    {{- if or $condcontentlen $condcontentnc -}}
    <p class="mb-0"><strong>
      {{- if $condcontentc -}}✅{{ end }}{{ if or $condcontentnc $condcontentlen }}❌{{ end }}&nbsp;Test {{ $thematiques }}.{{ $criteres }}.{{ $tests}} <small>- {{ if $condcontentc }}Conforme{{ end }}{{ if or $condcontentnc $condcontentlen }}Non conforme{{ end }}</small>
      {{ if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!F!" -}}<span class="badge good">Facile</span>{{- end -}}
      {{ if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!M!" -}}<span class="badge medium">Modéré</span>{{- end -}}
      {{ if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!D!" -}}<span class="badge bad">Difficile</span>{{- end -}}
    </strong></p>
    {{- if $condcontentlen }}<p class="m-0"><strong>{{ replace (replaceRE "!(.*)!" "" $content 1) "\n" "<br>" | markdownify }}</strong></p>{{ end }}
      {{- $s := where (index $.Site.Data.criteres "topics") "number" "eq" (int ($thematiques)) -}}
      {{- range $idx, $value := ((index (index $s 0).criteria (sub (int ($criteres)) 1)).criterium).tests -}}
        {{- if eq $idx (string ($tests)) -}}
        {{- if reflect.IsSlice . -}}
        <p><em>{{ (replaceRE "=\"#" "=\"/glossaire/#" ((index . 0) | markdownify) 100) | markdownify }}</em><br></p>
        {{- if (after 1 .) -}}
        <ol>
          {{ range after 1 . }}<li>{{ (replaceRE "=\"#" "=\"/glossaire/#" (. | markdownify) 100) | markdownify }}</li>{{ end }}
        </ol>
        {{- end -}}
        {{- else -}}
        <p><em>{{ (replaceRE "=\"#" "=\"/glossaire/#" (. | markdownify) 100) | markdownify }}</em></p>
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- end -}}
{{- end -}}

{{/* If serveral pages tested */}}
{{- if gt (len $pages) 1 -}}

{{/* Range map errors sort by RGAA order - on specifics pages */}}
<h3>B - Erreurs présentes sur les pages spécifiques</h3>
{{/* Display errors presents on specific pages */}}
{{- range $id, $value := $pages -}}
  {{ $.Scratch.Set "text" 0 }}
  {{ $page := . }}
  <h4 id="{{ . | urlize }}">♦︎ Page : {{ . }}</h4>
  {{- $.Scratch.Set "is-page-error" 0 -}}
  {{- range $key, $value := after 1 ($.Scratch.Get "auditfile-csv") -}}
  {{ if ne (len (uniq (after 3 .))) 1 }}
    {{- $content := (string (index . (add $id 3))) -}}
    {{- $condcontentlen := gt (len $content) 2 -}}
    {{- $condcontentnc := (eq $content "nc") -}}
    {{- $condcontentc := (eq $content "c") -}}
    {{- $thematiques := index $value 0 -}}
    {{- $criteres := index $value 1 -}}
    {{- $tests := index $value 2 -}}
    {{- if or $condcontentlen $condcontentnc -}}
    {{- $.Scratch.Add "is-page-error" 1 -}}
        <p class="mb-0"><strong>
        {{- if $condcontentc -}}✅{{ end }}{{ if or $condcontentnc $condcontentlen }}❌{{ end }} Test {{ $thematiques }}.{{ $criteres }}.{{ $tests}} <small>- {{ if $condcontentc }}Conforme{{ end }}{{ if or $condcontentnc $condcontentlen }}Non conforme{{ end }}</small>
        {{- if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!F!" -}}<span class="badge d-none good">Facile</span>{{- end -}}
        {{- if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!M!" -}}<span class="badge d-none medium">Modéré</span>{{- end -}}
        {{- if eq (upper (delimit (findRE "!(.*)!" $content) "")) "!D!" -}}<span class="badge d-none bad">Difficile</span>{{- end -}}
      </strong></p>
      {{- if $condcontentlen }}<p class="m-0"><strong>{{ replace (replaceRE "!(.*)!" "" $content 1) "\n" "<br>" | markdownify }}</strong></p>{{ end }}
        {{- $s := where (index $.Site.Data.criteres "topics") "number" "eq" (int ($thematiques)) -}}
        {{- range $idx, $value := ((index (index $s 0).criteria (sub (int ($criteres)) 1)).criterium).tests -}}
          {{- if eq $idx (string ($tests)) -}}
          {{- if reflect.IsSlice . -}}
          <p><em>{{ (replaceRE "=\"#" "=\"/glossaire/#" ((index . 0) | markdownify) 100) | markdownify }}</em><br></p>
          {{- if (after 1 .) -}}
          <ol>
            {{ range after 1 . }}<li>{{ (replaceRE "=\"#" "=\"/glossaire/#" (. | markdownify) 100) | markdownify }}</li>{{ end }}
          </ol>
          {{- end -}}
          {{- else -}}
          <p><em>{{ (replaceRE "=\"#" "=\"/glossaire/#" (. | markdownify) 100) | markdownify }}</em></p>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- if ge ($.Scratch.Get "is-page-error") 0 -}}<p>Aucune erreur spécifique sur cette page.</p>{{- end -}}
{{- end -}}
{{- end -}}
{{- if gt (len $pages) 0 -}}
<br><hr class="divider">
{{/* Range map errors sort by RGAA order - on all pages */}}
<h3 id="pagesall">Tous les critères non conformes du site</h3>
<div class="flex flex-column">
{{- range $key, $value := ($.Scratch.Get "valuecriterenonconformepage") -}}
  {{- $thematiques := index (split $key ".") 0 -}}
  {{- $criteres := index (split $key ".") 1 -}}
  <div style="order:{{ $thematiques }};">
  <p class="mb-0"><strong>Critère {{ $thematiques }}.{{ $criteres }}</strong></p>
  {{- $s := where (index $.Site.Data.criteres "topics") "number" "eq" (int (index (split $key ".") 0)) -}}
  {{- $content := (index (index $s 0).criteria (sub (int ($criteres)) 1)).criterium.title -}}
  <p><em>{{ (replaceRE "=\"#" "=\"/glossaire/#" ($content | markdownify) 100) | markdownify }}</em></p>
  </div>
{{- end -}}
</div>
{{- end -}}
{{- else -}}
  <p>Le fichier d’audit RGAA est vide pour le moment.</p>
{{- end -}}
</div>
{{- end -}}
