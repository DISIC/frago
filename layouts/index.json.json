{{- $context := . -}}
{{- $pagetype := slice "accessibility" "quality" "performance" -}}
{{- $.Scratch.Set "folder" "" -}}
{{- $.Scratch.Set "slugs" slice -}}
{{- range $id, $value := $pagetype -}}
  {{- range readDir "content/audits/" -}}{{- $slug := .Name -}}
    {{- $.Scratch.Add "slugs" $slug -}}
    {{- $.Scratch.Set "mainpath" (partial "render/check-rootpath-ressources" (dict "context" . "project" $slug "type" "accessibility")) -}}
    {{- range readDir (printf "content/audits/%s/" $slug) -}}
    {{- $.Scratch.Set "folder" $value -}}{{- if eq $value "performance" -}}{{- $.Scratch.Set "folder" "lighthouse" -}}{{- end -}}
    {{- if fileExists (printf "%s/%s/%s" ($.Scratch.Get "mainpath") $slug ($.Scratch.Get "folder")) -}}
        {{- $name := .Name -}}{{- if eq $name (printf "%s.md" $value) -}}{{- $.Scratch.SetInMap (printf "slug-%s" $slug) $value (printf "audits/%s/%s/" $slug $value) -}}{{- end -}}
    {{- end -}}
    {{- end -}}
    {{- $.Scratch.SetInMap "jsonslug" $slug ($.Scratch.Get (printf "slug-%s" $slug)) -}}
    {{- end -}}
{{- end -}}
{{- $.Scratch.Set "counter1" 0 -}}
{
  {{ if .Site.Title }}"name": "{{ .Site.Title }}",{{ end }}
  {{ if .Site.Params.organisation }}"description": {{ .Site.Params.organisation }},{{ end }}
  "websites":{
  {{- range $slug, $value := ($.Scratch.Get "jsonslug") -}}{{ $.Scratch.Set "counter2" 0 }}{{ $.Scratch.Add "counter1" 1 }}{{ if $context.GetPage (printf "audits/%s" $slug) }}
    "{{ $slug }}": {
      "title": "{{ with $context.GetPage (printf "audits/%s" $slug) }}{{ .Title }}{{ end }}",
      "slug": "{{ $slug }}",{{ range $id, $path := $value }}{{ $.Scratch.Add "counter2" 1 }}
      "{{ $id }}":{
        "url": "{{ printf "%sindex.json" . }}"{{ if eq $id "accessibility" }}{{ with (partial "render/accessibility" (dict "context" $context "auditfile" ((index (partial "render/accessibility-lastfile.html" (dict "context" $context "project" $slug)) "auditpath")))) }},
        "scores": {
          "criteria": {
            {{ if (index . "criteretotal") }}"total": {{ len (index . "criteretotal") }},{{ end }}
            {{ if (index . "critereconforme") }}"conforme": {{ len (index . "critereconforme") }},{{ end }}
            {{ if (index . "criterenonapplicable") }}"nonapplicable": {{ len (index . "criterenonapplicable") }},{{ end }}
            {{ if (index . "criterenonconforme") }}"nonconforme": {{ len (index . "criterenonconforme") }}{{ end }}
          },
          "accessibility" : {
            "compliance": {{ index . "critereconformepercent" }}
          }
        }{{ end }}{{ end }}{{ if eq $id "performance" }}{{ with (partial "render/accessibility" (dict "context" $context "auditfile" ((index (partial "render/accessibility-lastfile.html" (dict "context" $context "project" $slug)) "auditpath")))) }},
        "scores": {
          "criteria": {
            {{ if (index . "criteretotal") }}"total": {{ len (index . "criteretotal") }},{{ end }}
            {{ if (index . "critereconforme") }}"conforme": {{ len (index . "critereconforme") }},{{ end }}
            {{ if (index . "criterenonapplicable") }}"nonapplicable": {{ len (index . "criterenonapplicable") }},{{ end }}
            {{ if (index . "criterenonconforme") }}"nonconforme": {{ len (index . "criterenonconforme") }}{{ end }}
          },
          "accessibility" : {
            "conforme": {{ index . "critereconformepercent" }}
          }
        }{{ end }}{{ end }}
      }{{ if ne ($.Scratch.Get "counter2") (len $value) }},{{ end }}{{ end }}{{ end }}
    }{{ if ne ($.Scratch.Get "counter1") (len ($.Scratch.Get "jsonslug")) }},{{ end }}
  {{- end -}}
  }
}
